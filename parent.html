<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Parent Login</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      body {
        max-width: 900px;
        margin: 0 auto;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        margin: 12px 0;
      }
      .children-selector {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin: 12px 0;
      }
      .child-tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .child-tab {
        padding: 8px 16px;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .child-tab.active {
        background: var(--primary);
        color: var(--primary-contrast);
        border-color: var(--primary);
      }
      .child-tab:hover:not(.active) {
        background: #1f2937;
      }
      .login-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
      }
      .login-box {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 2rem;
        max-width: 400px;
        width: 100%;
      }
      .login-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        text-align: center;
        color: var(--primary);
      }
      @media print {
        .toolbar,
        .children-selector {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <!-- Login Section -->
    <section id="loginSection" class="login-container">
      <div class="login-box">
        <h2 class="login-title" data-i18n="parent_login">Parent Login</h2>
        <div class="form-row">
          <label data-i18n="username" for="username">Username</label>
          <input id="username" type="text" autocomplete="username" />
        </div>
        <div class="form-row">
          <label data-i18n="password" for="password">Password</label>
          <div class="password-input-group">
            <input
              id="password"
              type="password"
              autocomplete="current-password"
            />
            <button
              type="button"
              id="togglePassword"
              class="password-toggle"
              title="Show/Hide Password"
            >
              üëÅÔ∏è
            </button>
          </div>
        </div>
        <button id="loginBtn" class="primary" data-i18n="login">Login</button>
        <div id="loginMsg" class="msg" role="status"></div>
      </div>
    </section>

    <!-- Main App Section -->
    <section id="appSection" style="display: none">
      <header class="topbar">
        <div class="title" data-i18n="parent_report_title">Parent Report</div>
        <div class="spacer"></div>
        <div class="lang-controls">
          <label for="langSel" data-i18n="language">Language</label>
          <div class="custom-select">
            <select id="langSel">
              <option value="en">English</option>
              <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
            </select>
          </div>
        </div>
        <button id="changePasswordBtn" data-i18n="change_password">
          Change Password
        </button>
        <button id="logoutBtn" data-i18n="logout">Logout</button>
      </header>
      <main>
        <div class="toolbar">
          <button onclick="window.print()" data-i18n="print">Print</button>
          <button
            onclick="refreshParentData()"
            style="background: var(--primary); color: white"
          >
            Refresh Data
          </button>
        </div>
        <section class="pane">
          <h3 id="parentName">‚Äî</h3>
          <div
            class="children-selector"
            id="childrenSelector"
            style="display: none"
          >
            <label data-i18n="select_child">Select Child:</label>
            <div class="child-tabs" id="childTabs"></div>
          </div>
          <div id="tableWrap"></div>
        </section>
      </main>
    </section>

    <script>
      (function () {
        const I18N = {
          en: {
            parent_login: "Parent Login",
            username: "Username",
            password: "Password",
            login: "Login",
            logout: "Logout",
            parent_report_title: "Parent Report",
            language: "Language",
            print: "Print",
            select_child: "Select Child:",
            date: "Date",
            sura: "Sura",
            personal_correction: "Personal correction",
            teacher_correction: "Teacher correction",
            tajweed: "Tajweed",
            fluency: "Fluency",
            final_mark: "Final mark",
            no_data: "No data to display.",
            invalid_credentials: "Invalid username or password.",
            login_success: "Login successful!",
            change_password: "Change Password",
            current_password: "Current Password",
            cancel: "Cancel",
          },
          ar: {
            parent_login: "ÿØÿÆŸàŸÑ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±",
            username: "ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ",
            password: "ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±",
            login: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",
            logout: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨",
            parent_report_title: "ÿ™ŸÇÿ±Ÿäÿ± ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±",
            language: "ÿßŸÑŸÑÿ∫ÿ©",
            print: "ÿ∑ÿ®ÿßÿπÿ©",
            select_child: "ÿßÿÆÿ™ÿ± ÿßŸÑÿ∑ŸÅŸÑ:",
            date: "ÿßŸÑÿ™ÿßÿ±ŸäÿÆ",
            sura: "ÿßŸÑÿ≥Ÿàÿ±ÿ©",
            personal_correction: "ÿ™ÿµÿ≠Ÿäÿ≠ ÿ¥ÿÆÿµŸä",
            teacher_correction: "ÿ™ÿµÿ≠Ÿäÿ≠ ÿßŸÑŸÖÿπŸÑŸÖ",
            tajweed: "ÿ™ÿ¨ŸàŸäÿØ",
            fluency: "ÿ∑ŸÑÿßŸÇÿ©",
            final_mark: "ÿßŸÑÿØÿ±ÿ¨ÿ© ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ©",
            no_data: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿπÿ±ÿ∂.",
            invalid_credentials: "ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£Ÿà ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©.",
            login_success: "ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!",
            change_password: "ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±",
            current_password: "ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ≠ÿßŸÑŸäÿ©",
            cancel: "ÿ•ŸÑÿ∫ÿßÿ°",
          },
        };

        // Parent credentials (DEMO VERSION - Replace with real credentials in production)
        const PARENT_CREDENTIALS = {
          parent1: {
            password: "demo123",
            parentId: "P1",
            name: "Zakareeya A.'s Parent",
          },
          parent2: {
            password: "demo123",
            parentId: "P2",
            name: "Muhamad's Parent",
          },
          parent3: {
            password: "demo123",
            parentId: "P3",
            name: "Mousa's Parent",
          },
          parent4: {
            password: "demo123",
            parentId: "P4",
            name: "Zakariya M.'s Parent",
          },
          parent5: {
            password: "demo123",
            parentId: "P5",
            name: "Bara's Parent",
          },
          parent6: {
            password: "demo123",
            parentId: "P6",
            name: "Ali's Parent",
          },
          parent7: {
            password: "demo123",
            parentId: "P7",
            name: "Shorouk's Parent",
          },
          parent8: {
            password: "demo123",
            parentId: "P8",
            name: "Ibrahim's Parent",
          },
          parent9: {
            password: "demo123",
            parentId: "P9",
            name: "Belal's Parent",
          },
          parent10: {
            password: "demo123",
            parentId: "P10",
            name: "Juwariyyah's Parent",
          },
          parent11: {
            password: "demo123",
            parentId: "P11",
            name: "Lina's Parent",
          },
          parent12: {
            password: "demo123",
            parentId: "P12",
            name: "Jude's Parent",
          },
          parent13: {
            password: "demo123",
            parentId: "P13",
            name: "Aminah's Parent",
          },
        };

        // Surah names array
        const SURAS = [
          { id: "001", name: "Al-Fatiha" },
          { id: "002", name: "Al-Baqarah" },
          { id: "003", name: "Ali 'Imran" },
          { id: "004", name: "An-Nisa" },
          { id: "005", name: "Al-Ma'idah" },
          { id: "006", name: "Al-An'am" },
          { id: "007", name: "Al-A'raf" },
          { id: "008", name: "Al-Anfal" },
          { id: "009", name: "At-Tawbah" },
          { id: "010", name: "Yunus" },
          { id: "011", name: "Hud" },
          { id: "012", name: "Yusuf" },
          { id: "013", name: "Ar-Ra'd" },
          { id: "014", name: "Ibrahim" },
          { id: "015", name: "Al-Hijr" },
          { id: "016", name: "An-Nahl" },
          { id: "017", name: "Al-Isra" },
          { id: "018", name: "Al-Kahf" },
          { id: "019", name: "Maryam" },
          { id: "020", name: "Taha" },
          { id: "021", name: "Al-Anbiya" },
          { id: "022", name: "Al-Hajj" },
          { id: "023", name: "Al-Mu'minun" },
          { id: "024", name: "An-Nur" },
          { id: "025", name: "Al-Furqan" },
          { id: "026", name: "Ash-Shu'ara" },
          { id: "027", name: "An-Naml" },
          { id: "028", name: "Al-Qasas" },
          { id: "029", name: "Al-'Ankabut" },
          { id: "030", name: "Ar-Rum" },
          { id: "031", name: "Luqman" },
          { id: "032", name: "As-Sajdah" },
          { id: "033", name: "Al-Ahzab" },
          { id: "034", name: "Saba'" },
          { id: "035", name: "Fatir" },
          { id: "036", name: "Ya-Sin" },
          { id: "037", name: "As-Saffat" },
          { id: "038", name: "Sad" },
          { id: "039", name: "Az-Zumar" },
          { id: "040", name: "Ghafir" },
          { id: "041", name: "Fussilat" },
          { id: "042", name: "Ash-Shura" },
          { id: "043", name: "Az-Zukhruf" },
          { id: "044", name: "Ad-Dukhan" },
          { id: "045", name: "Al-Jathiyah" },
          { id: "046", name: "Al-Ahqaf" },
          { id: "047", name: "Muhammad" },
          { id: "048", name: "Al-Fath" },
          { id: "049", name: "Al-Hujurat" },
          { id: "050", name: "Qaf" },
          { id: "051", name: "Adh-Dhariyat" },
          { id: "052", name: "At-Tur" },
          { id: "053", name: "An-Najm" },
          { id: "054", name: "Al-Qamar" },
          { id: "055", name: "Ar-Rahman" },
          { id: "056", name: "Al-Waqi'ah" },
          { id: "057", name: "Al-Hadid" },
          { id: "058", name: "Al-Mujadila" },
          { id: "059", name: "Al-Hashr" },
          { id: "060", name: "Al-Mumtahanah" },
          { id: "061", name: "As-Saff" },
          { id: "062", name: "Al-Jumu'ah" },
          { id: "063", name: "Al-Munafiqun" },
          { id: "064", name: "At-Taghabun" },
          { id: "065", name: "At-Talaq" },
          { id: "066", name: "At-Tahrim" },
          { id: "067", name: "Al-Mulk" },
          { id: "068", name: "Al-Qalam" },
          { id: "069", name: "Al-Haqqah" },
          { id: "070", name: "Al-Ma'arij" },
          { id: "071", name: "Nuh" },
          { id: "072", name: "Al-Jinn" },
          { id: "073", name: "Al-Muzzammil" },
          { id: "074", name: "Al-Muddaththir" },
          { id: "075", name: "Al-Qiyamah" },
          { id: "076", name: "Al-Insan" },
          { id: "077", name: "Al-Mursalat" },
          { id: "078", name: "An-Naba'" },
          { id: "079", name: "An-Nazi'at" },
          { id: "080", name: "'Abasa" },
          { id: "081", name: "At-Takwir" },
          { id: "082", name: "Al-Infitar" },
          { id: "083", name: "Al-Mutaffifin" },
          { id: "084", name: "Al-Inshiqaq" },
          { id: "085", name: "Al-Buruj" },
          { id: "086", name: "At-Tariq" },
          { id: "087", name: "Al-A'la" },
          { id: "088", name: "Al-Ghashiyah" },
          { id: "089", name: "Al-Fajr" },
          { id: "090", name: "Al-Balad" },
          { id: "091", name: "Ash-Shams" },
          { id: "092", name: "Al-Layl" },
          { id: "093", name: "Ad-Duha" },
          { id: "094", name: "Ash-Sharh" },
          { id: "095", name: "At-Tin" },
          { id: "096", name: "Al-'Alaq" },
          { id: "097", name: "Al-Qadr" },
          { id: "098", name: "Al-Bayyinah" },
          { id: "099", name: "Az-Zalzalah" },
          { id: "100", name: "Al-'Adiyat" },
          { id: "101", name: "Al-Qari'ah" },
          { id: "102", name: "At-Takathur" },
          { id: "103", name: "Al-'Asr" },
          { id: "104", name: "Al-Humazah" },
          { id: "105", name: "Al-Fil" },
          { id: "106", name: "Quraysh" },
          { id: "107", name: "Al-Ma'un" },
          { id: "108", name: "Al-Kawthar" },
          { id: "109", name: "Al-Kafirun" },
          { id: "110", name: "An-Nasr" },
          { id: "111", name: "Al-Masad" },
          { id: "112", name: "Al-Ikhlas" },
          { id: "113", name: "Al-Falaq" },
          { id: "114", name: "An-Nas" },
        ];

        // Helper function to get Surah name from ID
        function getSurahName(surahId) {
          const surah = SURAS.find((s) => s.id === surahId);
          return surah ? surah.name : surahId;
        }

        let currentLanguage = localStorage.getItem("qrl_lang") || "en";
        let currentParent = null;

        function applyLanguage(lang) {
          currentLanguage = lang;
          localStorage.setItem("qrl_lang", lang);
          document.documentElement.lang = lang;
          document.documentElement.dir = lang === "ar" ? "rtl" : "ltr";

          for (const el of document.querySelectorAll("[data-i18n]")) {
            const key = el.getAttribute("data-i18n");
            if (I18N[lang] && I18N[lang][key]) {
              el.textContent = I18N[lang][key];
            }
          }
        }

        function show(element) {
          element.style.display = "block";
        }
        function hide(element) {
          element.style.display = "none";
        }

        function handleLogin() {
          const username = document.getElementById("username").value.trim();
          const password = document.getElementById("password").value;
          const msg = document.getElementById("loginMsg");

          if (!username || !password) {
            msg.textContent = I18N[currentLanguage].invalid_credentials;
            return;
          }

          const credentials = PARENT_CREDENTIALS[username];
          if (credentials && credentials.password === password) {
            currentParent = credentials;
            hide(document.getElementById("loginSection"));
            show(document.getElementById("appSection"));
            loadParentData();
            msg.textContent = I18N[currentLanguage].login_success;
          } else {
            msg.textContent = I18N[currentLanguage].invalid_credentials;
          }
        }

        function handleLogout() {
          currentParent = null;
          // Redirect to main landing page
          window.location.href = "index.html";
        }

        async function loadParentData() {
          if (!currentParent) return;

          try {
            // Try to load from server first
            try {
              const response = await fetch("/api/data");
              if (response.ok) {
                const data = await response.json();
                console.log("Loading parent data for:", currentParent.parentId);
                console.log("Server data:", data);

                // Find all children for this parent
                const children = data.students
                  ? data.students.filter(
                      (s) => s.parentId === currentParent.parentId
                    )
                  : [];

                console.log("Found children:", children);

                // Get entries for all children
                const entries = {};
                children.forEach((child) => {
                  entries[child.id] = data.entries[child.id] || [];
                  console.log(
                    `Entries for ${child.name} (${child.id}):`,
                    entries[child.id]
                  );
                });

                const parentData = {
                  parent: {
                    name: currentParent.name,
                    id: currentParent.parentId,
                  },
                  children: children,
                  entries: entries,
                  lang: currentLanguage,
                  accessDenied: false,
                };

                console.log("Final parent data:", parentData);
                render(currentLanguage, parentData);
                return;
              }
            } catch (serverError) {
              console.warn(
                "Failed to load from server, trying localStorage:",
                serverError
              );
            }

            // Fallback to localStorage
            const saved = localStorage.getItem("qrl_app_data");
            console.log("Loading parent data for:", currentParent.parentId);
            console.log("Raw data:", saved);

            if (saved) {
              const data = JSON.parse(saved);
              console.log("Parsed data:", data);

              // Find all children for this parent
              const children = data.students
                ? data.students.filter(
                    (s) => s.parentId === currentParent.parentId
                  )
                : [];

              console.log("Found children:", children);

              // Get entries for all children
              const entries = {};
              children.forEach((child) => {
                entries[child.id] = data.entries[child.id] || [];
                console.log(
                  `Entries for ${child.name} (${child.id}):`,
                  entries[child.id]
                );
              });

              const parentData = {
                parent: {
                  name: currentParent.name,
                  id: currentParent.parentId,
                },
                children: children,
                entries: entries,
                lang: currentLanguage,
                accessDenied: false,
              };

              console.log("Final parent data:", parentData);
              render(currentLanguage, parentData);
            } else {
              console.log("No saved data found in localStorage");
            }
          } catch (e) {
            console.error("Error loading parent data:", e);
          }
        }

        function renderChildrenTabs(children, currentChildId) {
          const tabsContainer = document.getElementById("childTabs");
          tabsContainer.innerHTML = "";

          children.forEach((child) => {
            const tab = document.createElement("div");
            tab.className = "child-tab";
            if (child.id === currentChildId) tab.classList.add("active");
            tab.textContent = child.name;
            tab.addEventListener("click", () => {
              // Remove active class from all tabs
              document
                .querySelectorAll(".child-tab")
                .forEach((t) => t.classList.remove("active"));
              // Add active class to clicked tab
              tab.classList.add("active");
              // Render table for selected child
              renderChildTable(child.id, data.entries[child.id] || []);
            });
            tabsContainer.appendChild(tab);
          });
        }

        function renderChildTable(childId, entries) {
          const wrap = document.getElementById("tableWrap");
          const t = I18N[currentLanguage];

          if (!entries || entries.length === 0) {
            wrap.innerHTML = '<div class="no-data">' + t.no_data + "</div>";
            return;
          }

          const head = [
            "date",
            "sura",
            "personal_correction",
            "teacher_correction",
            "tajweed",
            "fluency",
            "final_mark",
          ];
          let html =
            "<table><thead><tr>" +
            head.map((k) => "<th>" + t[k] + "</th>").join("") +
            "</tr></thead><tbody>";
          html += entries
            .map(
              (e) =>
                "<tr>" +
                [
                  e.date,
                  getSurahName(e.sura) || "",
                  e.personalCorrection,
                  e.teacherCorrection,
                  e.tajweed,
                  e.fluency,
                  e.finalMark,
                ]
                  .map((v) => "<td>" + escape(String(v)) + "</td>")
                  .join("") +
                "</tr>"
            )
            .join("");
          html += "</tbody></table>";
          wrap.innerHTML = html;
        }

        function render(lang, data) {
          const t = I18N[lang];
          document.title =
            t.parent_report_title +
            (data.parent?.name ? " - " + data.parent.name : "");
          document.documentElement.lang = lang;
          document.documentElement.dir = lang === "ar" ? "rtl" : "ltr";
          document.querySelector(".title").textContent = t.parent_report_title;
          document.querySelector('label[for="langSel"]').textContent =
            t.language;
          document.querySelector(".toolbar button").textContent = t.print;
          document.getElementById("parentName").textContent =
            data.parent?.name || "";

          const childrenSelector = document.getElementById("childrenSelector");
          const wrap = document.getElementById("tableWrap");

          if (data.accessDenied) {
            childrenSelector.style.display = "none";
            if (data.parent?.name === "Access Restricted") {
              wrap.innerHTML =
                '<div class="no-data">' + t.access_denied + "</div>";
            } else if (data.parent?.name === "Parent Not Found") {
              wrap.innerHTML =
                '<div class="no-data">' + t.parent_not_found + "</div>";
            } else {
              wrap.innerHTML =
                '<div class="no-data">' + t.access_denied + "</div>";
            }
            return;
          }

          if (data.children && data.children.length > 1) {
            // Multiple children - show selector
            childrenSelector.style.display = "block";
            document.querySelector('label[for="childTabs"]').textContent =
              t.select_child;
            renderChildrenTabs(data.children, data.children[0].id);
            renderChildTable(
              data.children[0].id,
              data.entries[data.children[0].id] || []
            );
          } else if (data.children && data.children.length === 1) {
            // Single child - hide selector, show data directly
            childrenSelector.style.display = "none";
            renderChildTable(
              data.children[0].id,
              data.entries[data.children[0].id] || []
            );
          } else {
            // No children
            childrenSelector.style.display = "none";
            wrap.innerHTML = '<div class="no-data">' + t.no_data + "</div>";
          }
        }

        function escape(s) {
          return s
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        // Initialize language
        const langSel = document.getElementById("langSel");
        langSel.value = currentLanguage;
        langSel.addEventListener("change", () => applyLanguage(langSel.value));
        applyLanguage(currentLanguage);

        // Login functionality
        document
          .getElementById("loginBtn")
          .addEventListener("click", handleLogin);
        document
          .getElementById("logoutBtn")
          .addEventListener("click", handleLogout);

        // Enter key support for login
        document
          .getElementById("username")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") handleLogin();
          });
        document
          .getElementById("password")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") handleLogin();
          });

        // Enter key support for parent portal
        document.addEventListener("keypress", function (e) {
          if (e.key === "Enter" && currentParent) {
            // Refresh data when Enter is pressed
            loadParentData();
          }
        });

        // Password toggle functionality
        function setupPasswordToggle(inputId, toggleId) {
          const input = document.getElementById(inputId);
          const toggle = document.getElementById(toggleId);
          if (input && toggle) {
            toggle.addEventListener("click", () => {
              if (input.type === "password") {
                input.type = "text";
                toggle.textContent = "üôà";
              } else {
                input.type = "password";
                toggle.textContent = "üëÅÔ∏è";
              }
            });
          }
        }

        // Setup password toggles
        setupPasswordToggle("password", "togglePassword");
        setupPasswordToggle("currentPassword", "toggleCurrentPassword");
        setupPasswordToggle("newPasswordChange", "toggleNewPasswordChange");
        setupPasswordToggle(
          "confirmPasswordChange",
          "toggleConfirmPasswordChange"
        );

        // Change password functionality
        document
          .getElementById("changePasswordBtn")
          .addEventListener("click", () => {
            document.getElementById("changePasswordModal").style.display =
              "flex";
            document.getElementById("currentPassword").value = "";
            document.getElementById("newPasswordChange").value = "";
            document.getElementById("confirmPasswordChange").value = "";
            document.getElementById("changePasswordMsg").textContent = "";
          });

        document
          .getElementById("saveNewPasswordBtn")
          .addEventListener("click", async () => {
            const currentPassword =
              document.getElementById("currentPassword").value;
            const newPassword =
              document.getElementById("newPasswordChange").value;
            const confirmPassword = document.getElementById(
              "confirmPasswordChange"
            ).value;
            const msg = document.getElementById("changePasswordMsg");

            if (!currentPassword || !newPassword || !confirmPassword) {
              msg.textContent = I18N[currentLanguage].invalid_credentials;
              return;
            }

            if (newPassword !== confirmPassword) {
              msg.textContent = I18N[currentLanguage].invalid_credentials;
              return;
            }

            if (newPassword.length < 6) {
              msg.textContent = I18N[currentLanguage].invalid_credentials;
              return;
            }

            // Verify current password matches parent's password
            const credentials = PARENT_CREDENTIALS[currentParent.username];
            if (credentials.password !== currentPassword) {
              msg.textContent = I18N[currentLanguage].invalid_credentials;
              return;
            }

            // Update parent password in credentials
            credentials.password = newPassword;

            msg.textContent = I18N[currentLanguage].login_success;
            setTimeout(() => {
              closeChangePasswordModal();
              handleLogout();
            }, 1500);
          });

        // Global function to close change password modal
        window.closeChangePasswordModal = function () {
          document.getElementById("changePasswordModal").style.display = "none";
        };

        // Auto-refresh data every 5 seconds when logged in
        setInterval(() => {
          if (currentParent) {
            loadParentData();
          }
        }, 5000);

        // Global function to debug localStorage data
        window.debugLocalStorage = function () {
          const data = localStorage.getItem("qrl_app_data");
          console.log("=== LOCALSTORAGE DEBUG ===");
          console.log("Raw data:", data);
          if (data) {
            const parsed = JSON.parse(data);
            console.log("Parsed data:", parsed);
            console.log("Students:", parsed.students);
            console.log("Entries:", parsed.entries);
            if (parsed.students) {
              const mousa = parsed.students.find((s) => s.name === "Mousa");
              console.log("Mousa student:", mousa);
              if (mousa) {
                console.log("Mousa entries:", parsed.entries[mousa.id]);
              }
            }
          }
          console.log("=== END DEBUG ===");
        };

        // Global function to refresh parent data
        window.refreshParentData = function () {
          console.log("Manual refresh triggered");
          if (currentParent) {
            loadParentData();
          } else {
            console.log("No current parent logged in");
            alert("Please login first");
          }
        };
      })();
    </script>
    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h3 data-i18n="change_password">Change Password</h3>
          <button class="modal-close" onclick="closeChangePasswordModal()">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="form-row">
            <label data-i18n="current_password" for="currentPassword"
              >Current Password</label
            >
            <div class="password-input-group">
              <input
                id="currentPassword"
                type="password"
                autocomplete="current-password"
              />
              <button
                type="button"
                id="toggleCurrentPassword"
                class="password-toggle"
                title="Show/Hide Password"
              >
                üëÅÔ∏è
              </button>
            </div>
          </div>
          <div class="form-row">
            <label data-i18n="new_password" for="newPasswordChange"
              >New Password</label
            >
            <div class="password-input-group">
              <input
                id="newPasswordChange"
                type="password"
                autocomplete="new-password"
              />
              <button
                type="button"
                id="toggleNewPasswordChange"
                class="password-toggle"
                title="Show/Hide Password"
              >
                üëÅÔ∏è
              </button>
            </div>
          </div>
          <div class="form-row">
            <label data-i18n="confirm_password" for="confirmPasswordChange"
              >Confirm New Password</label
            >
            <div class="password-input-group">
              <input
                id="confirmPasswordChange"
                type="password"
                autocomplete="new-password"
              />
              <button
                type="button"
                id="toggleConfirmPasswordChange"
                class="password-toggle"
                title="Show/Hide Password"
              >
                üëÅÔ∏è
              </button>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            id="saveNewPasswordBtn"
            class="primary"
            data-i18n="save_password"
          >
            Save Password
          </button>
          <button
            onclick="closeChangePasswordModal()"
            class="secondary"
            data-i18n="cancel"
          >
            Cancel
          </button>
        </div>
        <div id="changePasswordMsg" class="msg" role="status"></div>
      </div>
    </div>

    <!-- Optional embedded data for standalone file generation:
  <script id="data" type="application/json">{"parent":{"name":"..."},"children":[...],"entries":{...}}</script>
  --></body>
</html>
